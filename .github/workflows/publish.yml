name: Publish to npm

on:
  release:
    types: [released]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag (e.g., v1.2.3)'
        required: true
      release_id:
        description: 'GitHub release ID'
        required: true

concurrency:
  group: publish
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  id-token: write

env:
  NODE_VERSION: 22
  PNPM_VERSION: 10.13.1

jobs:
  publish:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.release.prerelease == false && !startsWith(github.event.release.tag_name, 'remote-'))
    steps:
      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ inputs.tag_name }}" >> "$GITHUB_OUTPUT"
            echo "release_id=${{ inputs.release_id }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
            echo "release_id=${{ github.event.release.id }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v6
        with:
          ref: ${{ steps.meta.outputs.ref }}
          fetch-depth: 0

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Upgrade npm for OIDC support
        run: npm install -g npm@latest

      - name: Download release assets
        uses: actions/github-script@v8
        env:
          RELEASE_ID: ${{ steps.meta.outputs.release_id }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const releaseId = process.env.RELEASE_ID;
            if (!releaseId) {
              core.setFailed('No release ID found.');
              return;
            }

            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId
            });

            const tgzAsset = release.data.assets.find((asset) => asset.name.endsWith('.tgz'));
            if (!tgzAsset) {
              core.setFailed('No .tgz file found in release assets');
              return;
            }

            const response = await github.rest.repos.getReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              asset_id: tgzAsset.id,
              headers: {
                Accept: 'application/octet-stream'
              }
            });

            fs.mkdirSync('agents-chatgroup-npx', { recursive: true });
            const filePath = path.join('agents-chatgroup-npx', tgzAsset.name);
            fs.writeFileSync(filePath, Buffer.from(response.data));

            console.log(`Downloaded ${tgzAsset.name} to ${filePath}`);
            core.setOutput('package-name', tgzAsset.name);

      - name: Verify package integrity
        id: verify
        shell: bash
        run: |
          set -euo pipefail
          cd agents-chatgroup-npx

          ls -la *.tgz
          npm pack --dry-run || echo 'Dry-run pack check reported differences (non-blocking).'

          PACKAGE_FILE=$(ls *.tgz | head -n1)
          echo "package-file=$PACKAGE_FILE" >> "$GITHUB_OUTPUT"

      - name: Publish to npm
        shell: bash
        run: |
          set -euo pipefail
          cd agents-chatgroup-npx

          PACKAGE_FILE='${{ steps.verify.outputs.package-file }}'
          echo "Publishing $PACKAGE_FILE to npm..."
          npm publish "$PACKAGE_FILE" --provenance --access public

      - name: Update release description
        uses: actions/github-script@v8
        env:
          RELEASE_ID: ${{ steps.meta.outputs.release_id }}
        with:
          script: |
            const releaseId = process.env.RELEASE_ID;
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId
            });

            const currentBody = release.data.body || '';
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              body: currentBody + '\n\nPublished to npm registry'
            });
